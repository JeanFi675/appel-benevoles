import{c as a,d as m,A as o,f as l,m as p,b as h}from"./utils-Bh8kB5Eo.js";const w={isAdmin:!1,loading:!0,activeTab:"postes",toasts:[],postes:[],benevoles:[],periodes:[],searchQuery:"",selectedBenevoleInscriptions:[],showDetailsModal:!1,showEditModal:!1,selectedBenevoleName:"",currentBenevole:null,newInscriptionForm:{periode_id:"",poste_id:""},editingPoste:null,posteForm:{titre:"",periode_id:"",periode_debut:"",periode_fin:"",referent_id:"",description:"",nb_min:1,nb_max:5},periodeForm:{nom:"",ordre:1},formatDateTime:m,formatDateTimeForInput:a,getReferents(){return this.benevoles.filter(e=>e.role==="referent"||e.role==="admin")},getFilteredBenevoles(){if(!this.searchQuery)return this.benevoles;const e=this.searchQuery.toLowerCase();return this.benevoles.filter(s=>s.nom&&s.nom.toLowerCase().includes(e)||s.prenom&&s.prenom.toLowerCase().includes(e)||s.email&&s.email.toLowerCase().includes(e))},getPostesForSelectedPeriod(){return this.newInscriptionForm.periode_id?this.postes.filter(e=>e.periode_id===this.newInscriptionForm.periode_id).sort((e,s)=>e.titre.localeCompare(s.titre)):[]},async viewBenevoleInscriptions(e){this.currentBenevole=e,this.selectedBenevoleName=`${e.prenom} ${e.nom}`,this.selectedBenevoleInscriptions=[],this.showDetailsModal=!0,await this.refreshBenevoleInscriptions()},async openEditBenevoleInscriptions(e){this.currentBenevole=e,this.selectedBenevoleName=`${e.prenom} ${e.nom}`,this.selectedBenevoleInscriptions=[],this.newInscriptionForm={periode_id:"",poste_id:""},this.showEditModal=!0,await this.refreshBenevoleInscriptions()},async refreshBenevoleInscriptions(){if(this.currentBenevole)try{const{data:e,error:s}=await o.fetch("inscriptions",{select:"*, postes(titre, periodes(nom, ordre), periode_debut, periode_fin)",eq:{benevole_id:this.currentBenevole.id}});if(s)throw s;this.selectedBenevoleInscriptions=(e||[]).map(t=>{const r=t.postes?.periode_debut?l(t.postes.periode_debut):"",i=t.postes?.periode_fin?l(t.postes.periode_fin):"";return{...t,poste_titre:t.postes?.titre||"Poste inconnu",periode_nom:t.postes?.periodes?.nom||"Période inconnue",periode_ordre:t.postes?.periodes?.ordre||999,horaire:r&&i?`${r} - ${i}`:""}}).sort((t,r)=>t.periode_ordre-r.periode_ordre)}catch(e){this.showToast("❌ Erreur chargement inscriptions : "+e.message,"error")}},async deleteInscription(e){if(!confirm("Êtes-vous sûr de vouloir supprimer cette inscription ?"))return;const s=[...this.selectedBenevoleInscriptions];this.selectedBenevoleInscriptions=this.selectedBenevoleInscriptions.filter(t=>t.id!==e);try{const{error:t}=await o.delete("inscriptions",{id:e});if(t)throw t;this.showToast("✅ Inscription supprimée","success"),this.loadBenevoles(),this.loadPostes()}catch(t){this.selectedBenevoleInscriptions=s,this.showToast("❌ Erreur suppression : "+t.message,"error")}},async addInscription(){if(!this.newInscriptionForm.periode_id||!this.newInscriptionForm.poste_id){this.showToast("⚠️ Veuillez sélectionner une période et un poste.","warning");return}if(this.postes.find(s=>s.id===this.newInscriptionForm.poste_id),this.selectedBenevoleInscriptions.some(s=>s.poste_id===this.newInscriptionForm.poste_id)){this.showToast("⚠️ Ce bénévole est déjà inscrit à ce poste.","warning");return}this.loading=!0;try{const s={benevole_id:this.currentBenevole.id,poste_id:this.newInscriptionForm.poste_id},{error:t}=await o.insert("inscriptions",s);if(t)throw t;this.showToast("✅ Inscription ajoutée !","success"),this.newInscriptionForm={periode_id:"",poste_id:""},await this.refreshBenevoleInscriptions(),this.loadBenevoles(),this.loadPostes()}catch(s){this.showToast("❌ Erreur ajout : "+s.message,"error")}finally{this.loading=!1}},closeInscriptionsModal(){this.showDetailsModal=!1,this.showEditModal=!1,this.selectedBenevoleInscriptions=[],this.selectedBenevoleName="",this.currentBenevole=null},async loadData(){await this.loadBenevoles(),await Promise.all([this.loadPostes(),this.loadPeriodes()])},async loadPostes(){try{const{data:e,error:s}=await o.fetch("postes",{select:"*, periodes(nom, ordre)"});if(s)throw s;const t=await Promise.all((e||[]).map(async r=>{const{data:i}=await o.fetch("inscriptions",{eq:{poste_id:r.id}}),d=i?i.length:0;let c="-";if(r.referent_id){const n=this.benevoles.find(u=>u.id===r.referent_id);n&&(c=`${n.prenom} ${n.nom}`)}return{...r,periode_nom:r.periodes?.nom||"-",periode_ordre:r.periodes?.ordre||999,inscrits_actuels:d,referent_identite:c}}));this.postes=t.sort((r,i)=>r.periode_ordre!==i.periode_ordre?r.periode_ordre-i.periode_ordre:new Date(r.periode_debut)-new Date(i.periode_debut))}catch(e){this.showToast("❌ Erreur chargement postes : "+e.message,"error")}},async loadBenevoles(){try{const{data:e,error:s}=await o.fetch("admin_benevoles",{order:{column:"nom",ascending:!0}});if(s)throw s;this.benevoles=e||[]}catch(e){this.showToast("❌ Erreur chargement bénévoles : "+e.message,"error")}},async loadPeriodes(){try{const{data:e,error:s}=await o.fetch("periodes",{order:{column:"ordre",ascending:!0}});if(s)throw s;this.periodes=e||[]}catch(e){this.showToast("❌ Erreur chargement périodes : "+e.message,"error")}},async savePoste(){this.loading=!0;try{const e={...this.posteForm,referent_id:this.posteForm.referent_id||null};if(this.editingPoste){const{error:s}=await o.update("postes",e,{id:this.editingPoste.id});if(s)throw s;this.showToast("✅ Poste modifié avec succès !","success")}else{const{error:s}=await o.insert("postes",e);if(s)throw s;this.showToast("✅ Poste créé avec succès !","success")}this.editingPoste=null,this.resetPosteForm(),await this.loadPostes()}catch(e){this.showToast("❌ Erreur : "+e.message,"error")}finally{this.loading=!1}},async deletePoste(e){if(confirm("Êtes-vous sûr de vouloir supprimer ce poste ?")){this.loading=!0;try{const{error:s}=await o.delete("postes",{id:e});if(s)throw s;this.showToast("✅ Poste supprimé","success"),await this.loadPostes()}catch(s){this.showToast("❌ Erreur : "+s.message,"error")}finally{this.loading=!1}}},editPoste(e){this.editingPoste=e,this.posteForm={titre:e.titre,periode_id:e.periode_id,periode_debut:a(e.periode_debut),periode_fin:a(e.periode_fin),referent_id:e.referent_id||"",description:e.description||"",nb_min:e.nb_min,nb_max:e.nb_max},window.scrollTo({top:0,behavior:"smooth"})},cancelEdit(){this.editingPoste=null,this.resetPosteForm()},resetPosteForm(){this.posteForm={titre:"",periode_id:"",periode_debut:"",periode_fin:"",referent_id:"",description:"",nb_min:1,nb_max:5}},async createPeriode(){this.loading=!0;try{const{error:e}=await o.insert("periodes",this.periodeForm);if(e)throw e;this.showToast("✅ Période créée avec succès !","success"),this.periodeForm={nom:"",ordre:this.periodes.length+1},await this.loadPeriodes()}catch(e){this.showToast("❌ Erreur : "+e.message,"error")}finally{this.loading=!1}},async updatePeriodeOrder(e,s){try{const{error:t}=await o.update("periodes",{ordre:parseInt(s)},{id:e});if(t)throw t;this.showToast("✅ Ordre mis à jour","success"),await this.loadPeriodes()}catch(t){this.showToast("❌ Erreur : "+t.message,"error")}},async renamePeriode(e){const s=prompt("Nouveau nom de la période :",e.nom);s&&s.trim()!==""&&s!==e.nom&&await this.updatePeriodeName(e.id,s.trim())},async updatePeriodeName(e,s){this.loading=!0;try{const{error:t}=await o.update("periodes",{nom:s},{id:e});if(t)throw t;this.showToast("✅ Nom de la période mis à jour","success"),await this.loadPeriodes()}catch(t){this.showToast("❌ Erreur : "+t.message,"error")}finally{this.loading=!1}},async deletePeriode(e){if(confirm("Êtes-vous sûr de vouloir supprimer cette période ?")){this.loading=!0;try{const{error:s}=await o.delete("periodes",{id:e});if(s)throw s;this.showToast("✅ Période supprimée","success"),await this.loadPeriodes()}catch(s){this.showToast("❌ Erreur : "+s.message,"error")}finally{this.loading=!1}}},getPostesCountForPeriode(e){return this.postes.filter(s=>s.periode_id===e).length},async updateBenevoleRole(e,s){try{const{error:t}=await o.update("benevoles",{role:s},{id:e});if(t)throw t;if(s==="benevole"){const{error:i}=await o.updateMany("postes",{referent_id:null},{referent_id:e});i?(console.error("Error removing referent from posts:",i),this.showToast("⚠️ Rôle changé, mais erreur lors du retrait des postes.","warning")):await this.loadPostes()}const r={benevole:"Bénévole",referent:"Référent",admin:"Admin"};this.showToast(`✅ Rôle changé en ${r[s]}`,"success"),await this.loadBenevoles()}catch(t){this.showToast("❌ Erreur : "+t.message,"error"),await this.loadBenevoles()}},showToast(e,s="success"){const t=Date.now();this.toasts.push({id:t,message:e,type:s}),setTimeout(()=>{this.toasts=this.toasts.filter(r=>r.id!==t)},5e3)}};document.addEventListener("alpine:init",()=>{p.data("adminApp",()=>({...w,async init(){const{user:e}=await h.getSession();if(!e){window.location.href="index.html";return}const{data:s,error:t}=await o.fetch("benevoles",{eq:{id:e.id},select:"role"}),r=s&&s.length>0?s[0]:null;if(t||!r||r.role!=="admin"){this.isAdmin=!1,this.loading=!1;return}this.isAdmin=!0,this.loading=!1,await this.loadData(),h.onAuthStateChange(async(i,d)=>{i==="SIGNED_IN"&&window.location.hash.includes("access_token")&&window.history.replaceState(null,"",window.location.pathname)})}}))});p.start();
