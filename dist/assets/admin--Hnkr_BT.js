import{c as p,A as o,d as c,m as l,b as h}from"./utils-Byl3V9oy.js";const m={isAdmin:!1,loading:!0,activeTab:"postes",toasts:[],postes:[],benevoles:[],periodes:[],editingPoste:null,posteForm:{titre:"",periode_id:"",periode_debut:"",periode_fin:"",referent_id:"",description:"",nb_min:1,nb_max:5},periodeForm:{nom:"",ordre:1},formatDateTime:p,get referents(){return this.benevoles.filter(e=>e.role==="referent")},async loadData(){await Promise.all([this.loadPostes(),this.loadBenevoles(),this.loadPeriodes()])},async loadPostes(){try{const{data:e,error:t}=await o.fetch("postes",{select:"*, periodes(nom, ordre)"});if(t)throw t;const s=await Promise.all((e||[]).map(async r=>{var n,d;const{data:i}=await o.fetch("inscriptions",{eq:{poste_id:r.id},select:"*"}),{data:a}=await o.fetch("inscriptions",{eq:{poste_id:r.id}}),u=a?a.length:0;return{...r,periode_nom:((n=r.periodes)==null?void 0:n.nom)||"-",periode_ordre:((d=r.periodes)==null?void 0:d.ordre)||999,inscrits_actuels:u}}));this.postes=s.sort((r,i)=>r.periode_ordre!==i.periode_ordre?r.periode_ordre-i.periode_ordre:new Date(r.periode_debut)-new Date(i.periode_debut))}catch(e){this.showToast("❌ Erreur chargement postes : "+e.message,"error")}},async loadBenevoles(){try{const{data:e,error:t}=await o.fetch("admin_benevoles",{order:{column:"nom",ascending:!0}});if(t)throw t;this.benevoles=e||[]}catch(e){this.showToast("❌ Erreur chargement bénévoles : "+e.message,"error")}},async loadPeriodes(){try{const{data:e,error:t}=await o.fetch("periodes",{order:{column:"ordre",ascending:!0}});if(t)throw t;this.periodes=e||[]}catch(e){this.showToast("❌ Erreur chargement périodes : "+e.message,"error")}},async savePoste(){this.loading=!0;try{if(this.editingPoste){const{error:e}=await o.update("postes",this.posteForm,{id:this.editingPoste.id});if(e)throw e;this.showToast("✅ Poste modifié avec succès !","success")}else{const{error:e}=await o.insert("postes",this.posteForm);if(e)throw e;this.showToast("✅ Poste créé avec succès !","success")}this.editingPoste=null,this.resetPosteForm(),await this.loadPostes()}catch(e){this.showToast("❌ Erreur : "+e.message,"error")}finally{this.loading=!1}},async deletePoste(e){if(confirm("Êtes-vous sûr de vouloir supprimer ce poste ?")){this.loading=!0;try{const{error:t}=await o.delete("postes",{id:e});if(t)throw t;this.showToast("✅ Poste supprimé","success"),await this.loadPostes()}catch(t){this.showToast("❌ Erreur : "+t.message,"error")}finally{this.loading=!1}}},editPoste(e){this.editingPoste=e,this.posteForm={titre:e.titre,periode_id:e.periode_id,periode_debut:c(e.periode_debut),periode_fin:c(e.periode_fin),referent_id:e.referent_id||"",description:e.description||"",nb_min:e.nb_min,nb_max:e.nb_max},window.scrollTo({top:0,behavior:"smooth"})},cancelEdit(){this.editingPoste=null,this.resetPosteForm()},resetPosteForm(){this.posteForm={titre:"",periode_id:"",periode_debut:"",periode_fin:"",referent_id:"",description:"",nb_min:1,nb_max:5}},async createPeriode(){this.loading=!0;try{const{error:e}=await o.insert("periodes",this.periodeForm);if(e)throw e;this.showToast("✅ Période créée avec succès !","success"),this.periodeForm={nom:"",ordre:this.periodes.length+1},await this.loadPeriodes()}catch(e){this.showToast("❌ Erreur : "+e.message,"error")}finally{this.loading=!1}},async updatePeriodeOrder(e,t){try{const{error:s}=await o.update("periodes",{ordre:parseInt(t)},{id:e});if(s)throw s;this.showToast("✅ Ordre mis à jour","success"),await this.loadPeriodes()}catch(s){this.showToast("❌ Erreur : "+s.message,"error")}},async deletePeriode(e){if(confirm("Êtes-vous sûr de vouloir supprimer cette période ?")){this.loading=!0;try{const{error:t}=await o.delete("periodes",{id:e});if(t)throw t;this.showToast("✅ Période supprimée","success"),await this.loadPeriodes()}catch(t){this.showToast("❌ Erreur : "+t.message,"error")}finally{this.loading=!1}}},getPostesCountForPeriode(e){return this.postes.filter(t=>t.periode_id===e).length},async updateBenevoleRole(e,t){try{const{error:s}=await o.update("benevoles",{role:t},{id:e});if(s)throw s;const r={benevole:"Bénévole",referent:"Référent",admin:"Admin"};this.showToast(`✅ Rôle changé en ${r[t]}`,"success"),await this.loadBenevoles()}catch(s){this.showToast("❌ Erreur : "+s.message,"error"),await this.loadBenevoles()}},showToast(e,t="success"){const s=Date.now();this.toasts.push({id:s,message:e,type:t}),setTimeout(()=>{this.toasts=this.toasts.filter(r=>r.id!==s)},5e3)}};document.addEventListener("alpine:init",()=>{l.data("adminApp",()=>({...m,async init(){const{user:e}=await h.getSession();if(!e){window.location.href="index.html";return}const{data:t,error:s}=await o.fetch("benevoles",{eq:{id:e.id},select:"role"}),r=t&&t.length>0?t[0]:null;if(s||!r||r.role!=="admin"){this.isAdmin=!1,this.loading=!1;return}this.isAdmin=!0,this.loading=!1,await this.loadData(),h.onAuthStateChange(async(i,a)=>{i==="SIGNED_IN"&&window.location.hash.includes("access_token")&&window.history.replaceState(null,"",window.location.pathname)})}}))});l.start();
