import{A as r,f as c,a as d,m as n,b as a}from"./utils-Byl3V9oy.js";const f={profiles:[],showProfileSection:!1,isEditingProfile:!1,profileForm:{id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""},toggleProfileSection(){this.showProfileSection=!this.showProfileSection,this.isEditingProfile=!1,this.showProfileSection||this.loadProfiles()},editProfile(e){const s=this.profiles.find(i=>i.id===e);s&&(this.profileForm={id:s.id,prenom:s.prenom||"",nom:s.nom||"",telephone:s.telephone||"",taille_tshirt:s.taille_tshirt||""},this.isEditingProfile=!0)},createProfile(){this.profileForm={id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""},this.isEditingProfile=!0},cancelEdit(){this.isEditingProfile=!1,this.profileForm={id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""}},async loadProfiles(){if(this.user)try{const{data:e,error:s}=await r.fetch("benevoles",{eq:{user_id:this.user.id},order:{column:"created_at",ascending:!0}});if(s)throw s;this.profiles=e||[]}catch(e){console.error("Erreur chargement profils:",e)}},async saveProfile(){if(this.user){this.loading=!0;try{const e={user_id:this.user.id,email:this.user.email,prenom:this.profileForm.prenom,nom:this.profileForm.nom,telephone:this.profileForm.telephone,taille_tshirt:this.profileForm.taille_tshirt};this.profileForm.id&&(e.id=this.profileForm.id);const{error:s}=await r.upsert("benevoles",e);if(s)throw s;this.showToast("âœ… Profil enregistrÃ© !","success"),this.isEditingProfile=!1,await this.loadProfiles(),this.loadPostes&&await this.loadPostes()}catch(e){this.showToast("âŒ Erreur : "+e.message,"error")}finally{this.loading=!1}}},async deleteProfile(e){if(confirm("ÃŠtes-vous sÃ»r de vouloir supprimer ce profil ? Cette action est irrÃ©versible.")){this.loading=!0;try{const{error:s}=await r.delete("benevoles",{id:e});if(s)throw s;this.showToast("âœ… Profil supprimÃ©","success"),await this.loadProfiles(),this.loadPostes&&await this.loadPostes()}catch(s){this.showToast("âŒ Erreur : "+s.message,"error")}finally{this.loading=!1}}}},u={postes:[],userInscriptions:[],showMyInscriptions:!1,showOnlyAvailable:!1,selectedPosteForRegistration:null,formatDate:d,formatTime:c,async loadPostes(){try{const{data:e,error:s}=await r.fetch("public_planning",{order:{column:"periode_debut",ascending:!0}});if(s)throw s;this.postes=e||[]}catch(e){this.showToast("âŒ Erreur chargement postes : "+e.message,"error")}},async loadUserInscriptions(){if(this.user)try{const{data:e,error:s}=await r.fetch("inscriptions",{select:"*, postes(*)",eq:{benevole_id:this.user.id}}),{data:i,error:t}=await r.fetch("inscriptions");if(t)throw t;this.userInscriptions=i||[]}catch(e){console.error("Erreur chargement inscriptions:",e)}},openRegistrationModal(e){this.selectedPosteForRegistration=e},closeRegistrationModal(){this.selectedPosteForRegistration=null},async register(e,s){if(!(!this.user||!s)){this.loading=!0;try{const{error:i}=await r.insert("inscriptions",{poste_id:e,benevole_id:s});if(i)throw i;this.showToast("âœ… Inscription rÃ©ussie !","success"),await this.loadPostes(),await this.loadUserInscriptions()}catch(i){this.showToast("âŒ "+i.message,"error")}finally{this.loading=!1}}},async unregister(e,s){if(!(!this.user||!s)&&confirm("ÃŠtes-vous sÃ»r de vouloir dÃ©sinscrire ce bÃ©nÃ©vole ?")){this.loading=!0;try{const{error:i}=await r.delete("inscriptions",{poste_id:e,benevole_id:s});if(i)throw i;this.showToast("âœ… DÃ©sinscription rÃ©ussie","success"),await this.loadPostes(),await this.loadUserInscriptions()}catch(i){this.showToast("âŒ Erreur : "+i.message,"error")}finally{this.loading=!1}}},isUserRegistered(e){return this.userInscriptions.some(s=>s.poste_id==e)},isProfileRegistered(e,s){return this.userInscriptions.some(i=>i.poste_id==e&&i.benevole_id==s)},hasTimeConflict(e,s=null){const i=new Date(e.periode_debut),t=new Date(e.periode_fin);return this.userInscriptions.some(o=>{if(s&&o.benevole_id!==s||o.poste_id==e.poste_id||!o.postes)return!1;const l=new Date(o.postes.periode_debut),h=new Date(o.postes.periode_fin);return i<h&&t>l})},filteredPostes(){return this.postes.filter(e=>{if(this.showOnlyAvailable){const s=e.inscrits_actuels>=e.nb_max,i=this.isUserRegistered(e.poste_id);if(s&&!i)return!1}return!(this.showMyInscriptions&&!this.isUserRegistered(e.poste_id))})},groupedPostes(){const e={};return this.filteredPostes().forEach(s=>{e[s.periode]||(e[s.periode]=[]),e[s.periode].push(s)}),Object.keys(e).map(s=>{const i=e[s],t=i.length>0&&i[0].periode_ordre||0;return{name:s,postes:i,order:t}}).sort((s,i)=>s.order-i.order)}};function p(){n.data("app",()=>({user:null,loading:!1,toasts:[],...f,...u,async init(){const{user:e}=await a.getSession();e&&(this.user=e,await this.loadInitialData()),a.onAuthStateChange(async(s,i)=>{this.user=(i==null?void 0:i.user)||null,s==="SIGNED_IN"?(window.location.hash.includes("access_token")&&window.history.replaceState(null,"",window.location.pathname),await this.loadInitialData()):s==="SIGNED_OUT"&&this.resetData()})},async loadInitialData(){this.user&&await Promise.all([this.loadProfiles(),this.loadPostes(),this.loadUserInscriptions()])},resetData(){this.profiles=[],this.postes=[],this.userInscriptions=[]},loginEmail:"",async sendMagicLink(){if(this.loginEmail){this.loading=!0;try{const{error:e}=await a.signInWithOtp(this.loginEmail);if(e)throw e;this.showToast("ðŸ“§ VÃ©rifiez votre boÃ®te mail !","success"),this.loginEmail=""}catch(e){this.showToast("âŒ Erreur : "+e.message,"error")}finally{this.loading=!1}}},async logout(){await a.signOut()},showToast(e,s="success"){const i=Date.now();this.toasts.push({id:i,message:e,type:s}),setTimeout(()=>{this.toasts=this.toasts.filter(t=>t.id!==i)},5e3)}}))}p();n.start();
