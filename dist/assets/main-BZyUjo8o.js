const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./utils-Bh8kB5Eo.js","./utils-7krzjOQW.css"])))=>i.map(i=>d[i]);
import{A as u,f as z,a as v,m as _,b as g}from"./utils-Bh8kB5Eo.js";const S={profiles:[],showProfileSection:!1,isEditingProfile:!1,loading:!1,profileForm:{id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""},toggleProfileSection(){this.showProfileSection=!this.showProfileSection,this.isEditingProfile=!1,this.showProfileSection||this.loadProfiles()},editProfile(e){const t=this.profiles.find(i=>i.id===e);t&&(this.profileForm={id:t.id,prenom:t.prenom||"",nom:t.nom||"",telephone:t.telephone||"",taille_tshirt:t.taille_tshirt||""},this.isEditingProfile=!0)},createProfile(){this.showProfileSection=!0,this.profileForm={id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""},this.isEditingProfile=!0},cancelEdit(){this.isEditingProfile=!1,this.profileForm={id:null,prenom:"",nom:"",telephone:"",taille_tshirt:""}},async loadProfiles(){if(this.user)try{const{data:e,error:t}=await u.fetch("benevoles",{eq:{user_id:this.user.id},order:{column:"created_at",ascending:!0}});if(t)throw t;this.profiles=e||[]}catch(e){console.error("Erreur chargement profils:",e)}},async saveProfile(){if(this.user){if(!this.profileForm.prenom||!this.profileForm.nom||!this.profileForm.telephone||!this.profileForm.taille_tshirt){this.showToast("âŒ Veuillez remplir tous les champs obligatoires (*)","error");return}this.loading=!0;try{const e={user_id:this.user.id,email:this.user.email,prenom:this.profileForm.prenom,nom:this.profileForm.nom,telephone:this.profileForm.telephone,taille_tshirt:this.profileForm.taille_tshirt};this.profileForm.id&&(e.id=this.profileForm.id);const{error:t}=await u.upsert("benevoles",e);if(t)throw t;this.showToast("âœ… Profil enregistrÃ© !","success"),this.loading=!1,await this.loadProfiles(),await this.askConfirm("Voulez-vous ajouter un autre bÃ©nÃ©vole ?","SuccÃ¨s !")?this.createProfile():(this.loadPostes&&await this.loadPostes(),this.isEditingProfile=!1,this.showProfileSection=!1)}catch(e){this.showToast("âŒ Erreur : "+e.message,"error")}finally{this.loading=!1}}},async deleteProfile(e){if(await this.askConfirm("ÃŠtes-vous sÃ»r de vouloir supprimer ce profil ? Cette action est irrÃ©versible.","Suppression")){this.loading=!0;try{const{error:t}=await u.delete("benevoles",{id:e});if(t)throw t;this.showToast("âœ… Profil supprimÃ©","success"),await this.loadProfiles(),this.loadPostes&&await this.loadPostes()}catch(t){this.showToast("âŒ Erreur : "+t.message,"error")}finally{this.loading=!1}}}},b="modulepreload",R=function(e,t){return new URL(e,t).href},P={},y=function(t,i,s){let r=Promise.resolve();if(i&&i.length>0){let d=function(h){return Promise.all(h.map(c=>Promise.resolve(c).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};const o=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");r=d(i.map(h=>{if(h=R(h,s),h in P)return;P[h]=!0;const c=h.endsWith(".css"),p=c?'[rel="stylesheet"]':"";if(s)for(let m=o.length-1;m>=0;m--){const w=o[m];if(w.href===h&&(!c||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${p}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":b,c||(f.as="script"),f.crossOrigin="",f.href=h,l&&f.setAttribute("nonce",l),document.head.appendChild(f),c)return new Promise((m,w)=>{f.addEventListener("load",m),f.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${h}`)))})}))}function n(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return r.then(o=>{for(const a of o||[])a.status==="rejected"&&n(a.reason);return t().catch(n)})},E={postes:[],userInscriptions:[],showMyInscriptions:!1,showOnlyAvailable:!1,selectedVolunteerId:"",selectedPosteForRegistration:null,showReferentView:!1,showReferentView:!1,referentInscriptions:[],referentProfiles:[],selectedReferentProfileId:null,showReferentSelectionModal:!1,viewMode:window.innerWidth>=768?"week":"list",calendarPage:0,itemsPerPage:4,PIXELS_PER_HOUR:35,START_HOUR:6,END_HOUR:28,formatDate:v,formatTime:z,getPosteStyle(e){const t=new Date(e.periode_debut),i=new Date(e.periode_fin);let s=t.getHours()+t.getMinutes()/60,r=i.getHours()+i.getMinutes()/60;s<this.START_HOUR&&(s+=24),r<this.START_HOUR&&(r+=24),r<s&&(r+=24);const n=(s-this.START_HOUR)*this.PIXELS_PER_HOUR,a=(r-s)*this.PIXELS_PER_HOUR;return`top: ${n}px; height: ${a}px; position: absolute; width: 100%;`},getCalendarHeight(){return(this.END_HOUR-this.START_HOUR)*this.PIXELS_PER_HOUR+"px"},toggleView(){this.viewMode=this.viewMode==="list"?"week":"list",this.calendarPage=0,this.showReferentView=!1},toggleReferentView(){this.showReferentView=!this.showReferentView,this.showReferentView&&(this.showMyInscriptions=!1,this.referentProfiles=this.profiles.filter(e=>this.postes.some(t=>t.referent_id===e.id)),this.referentProfiles.length>1?this.showReferentSelectionModal=!0:this.referentProfiles.length===1?(this.selectedReferentProfileId=this.referentProfiles[0].id,this.loadReferentInscriptions()):this.referentInscriptions=[])},selectReferent(e){this.selectedReferentProfileId=e,this.showReferentSelectionModal=!1,this.loadReferentInscriptions()},getMyReferentsList(){const e=this._getSortedActiveDates(),t=this.calendarPage*this.itemsPerPage,i=e.slice(t,t+this.itemsPerPage),s=new Set(i.map(o=>o.toDateString())),r=new Map;return this.postes.filter(o=>{const a=this.isUserRegistered(o.poste_id),l=new Date(o.periode_debut).toDateString(),d=s.has(l);return a&&d}).forEach(o=>{if(o.referent_id&&o.referent_nom){r.has(o.referent_id)||r.set(o.referent_id,{id:o.referent_id,nom:o.referent_nom,email:o.referent_email,telephone:o.referent_telephone,posts:[]});const a=r.get(o.referent_id);a.posts.includes(o.titre)||a.posts.push(o.titre)}}),Array.from(r.values())},_getSortedActiveDates(){const e=this.filteredPostes();if(e.length===0)return[];const t=new Set;return e.forEach(i=>{const s=new Date(i.periode_debut);s.setHours(0,0,0,0),t.add(s.getTime())}),Array.from(t).sort((i,s)=>i-s).map(i=>new Date(i))},getCalendarData(){const e=this._getSortedActiveDates(),t=this.calendarPage*this.itemsPerPage,i=e.slice(t,t+this.itemsPerPage),s=this.filteredPostes();return i.map(r=>{const n=r.toDateString(),o=(this.profiles||[]).map(a=>{const l=s.filter(d=>{const c=new Date(d.periode_debut).toDateString()===n,p=this.isProfileRegistered(d.poste_id,a.id);return c&&p});return l.sort((d,h)=>new Date(d.periode_debut)-new Date(h.periode_debut)),{profile:a,postes:l}});return{date:r,formattedDate:r.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"short"}),profiles:o}})},nextPage(){this.hasNextPage()&&this.calendarPage++},prevPage(){this.hasPrevPage()&&this.calendarPage--},hasNextPage(){const e=this._getSortedActiveDates().length;return(this.calendarPage+1)*this.itemsPerPage<e},hasPrevPage(){return this.calendarPage>0},async loadPostes(){try{const{data:e,error:t}=await u.fetch("public_planning",{order:{column:"periode_debut",ascending:!0}});if(t)throw t;this.postes=e||[],this.userInscriptions&&this.userInscriptions.length>0&&this.reconcileLocalCounts()}catch(e){this.showToast("âŒ Erreur chargement postes : "+e.message,"error")}},reconcileLocalCounts(){!this.postes||!this.userInscriptions||this.postes.forEach(e=>{const t=this.userInscriptions.filter(i=>i.poste_id==e.poste_id).length;Number(e.inscrits_actuels)<t&&(console.warn(`âš ï¸ Fixing stale count for "${e.titre}": ${e.inscrits_actuels} -> ${t}`),e.inscrits_actuels=t)})},async loadUserInscriptions(){if(this.user)try{const{data:e,error:t}=await u.fetch("inscriptions",{select:"*, postes(*)"});if(t)throw t;this.userInscriptions=e||[]}catch(e){console.error("Erreur chargement inscriptions:",e)}},isReferent(){return!this.user||!this.postes.length||!this.profiles?!1:this.postes.some(e=>this.profiles.some(t=>t.id===e.referent_id))},async loadReferentInscriptions(){if(!this.user||!this.selectedReferentProfileId)return;const e=this.postes.filter(t=>t.referent_id===this.selectedReferentProfileId).map(t=>t.poste_id);if(e.length===0){this.referentInscriptions=[];return}this.referentInscriptions=[],this.loading=!0;try{const{data:t,error:i}=await y(async()=>{const{supabase:s}=await import("./utils-Bh8kB5Eo.js").then(r=>r.e);return{supabase:s}},__vite__mapDeps([0,1]),import.meta.url).then(({supabase:s})=>s.from("inscriptions").select("*, benevoles(*), postes(*)").in("poste_id",e));if(i)throw i;this.referentInscriptions=t||[]}catch(t){console.error("Erreur chargement inscriptions rÃ©fÃ©rent:",t),this.showToast("âŒ Erreur chargement bÃ©nÃ©voles: "+t.message,"error")}finally{this.loading=!1}},getReferentViewData(){const e={};return this.referentInscriptions.forEach(t=>{if(!t.postes||!t.benevoles)return;const i=t.postes.id,s=this.postes.find(o=>o.poste_id===i),r=s?s.periode:"Autre",n=s?s.periode_ordre||0:999;e[r]||(e[r]={name:r,order:n,postes:{}}),e[r].postes[i]||(e[r].postes[i]={...t.postes,titre:s?s.titre:t.postes.titre,periode_debut:s?s.periode_debut:t.postes.periode_debut,periode_fin:s?s.periode_fin:t.postes.periode_fin,nb_min:s?s.nb_min:t.postes.nb_min,nb_max:s?s.nb_max:t.postes.nb_max,inscrits_actuels:s?s.inscrits_actuels:0,volunteers:[]}),e[r].postes[i].volunteers.push(t.benevoles)}),Object.values(e).sort((t,i)=>t.order-i.order).map(t=>{const i=Object.values(t.postes).sort((s,r)=>new Date(s.periode_debut)-new Date(r.periode_debut));return i.forEach(s=>{s.volunteers.sort((r,n)=>{const o=(r.prenom||"").toLowerCase(),a=(n.prenom||"").toLowerCase();if(o<a)return-1;if(o>a)return 1;const l=(r.nom||"").toLowerCase(),d=(n.nom||"").toLowerCase();return l.localeCompare(d)})}),{name:t.name,postes:i}})},openRegistrationModal(e){this.selectedPosteForRegistration=e},closeRegistrationModal(){this.selectedPosteForRegistration=null},async register(e,t){if(this.user)return this.wizardOpen?this.wizardRegister(e,t):this.openWizardWithContext(e,t,"register")},async unregister(e,t){if(this.user)return this.wizardOpen?this.wizardUnregister(e,t):this.openWizardWithContext(e,t,"unregister")},isProfileRegistered(e,t){if(!this.userInscriptions)return!1;const i=this.userInscriptions.some(s=>s.poste_id==e&&s.benevole_id==t);if(this.wizardOpen){if(this.wizardRemovals&&this.wizardRemovals.includes(`${e}::${t}`))return!1;if(this.wizardSelections&&this.wizardSelections.some(r=>r.posteId==e&&r.profileId==t))return!0}return i},isUserRegistered(e){if(!this.profiles||this.profiles.length===0)return!1;const t=this.profiles.map(s=>s.id),i=this.userInscriptions.some(s=>s.poste_id==e&&t.includes(s.benevole_id));if(this.wizardOpen&&this.wizardSelections){const s=this.wizardSelections.some(r=>r.posteId==e);return i||s}return i},hasTimeConflict(e,t=null){const i=[...this.userInscriptions.filter(n=>(t?n.benevole_id===t:!0)&&(!this.wizardOpen||!this.wizardRemovals||!this.wizardRemovals.includes(`${n.poste_id}::${n.benevole_id}`))),...this.wizardOpen?this.wizardSelections.filter(n=>t?n.profileId===t:!0).map(n=>({poste_id:n.posteId,benevole_id:n.profileId,postes:{periode_debut:n.debut,periode_fin:n.fin,id:n.posteId}})):[]],s=new Date(e.periode_debut).getTime(),r=new Date(e.periode_fin).getTime();return i.some(n=>{const o=n.postes;if(!o||n.poste_id===e.poste_id||t&&n.benevole_id!==t)return!1;const a=new Date(o.periode_debut).getTime(),l=new Date(o.periode_fin).getTime();return s<l&&r>a})},filteredPostes(){return this.postes.filter(e=>{if(this.showOnlyAvailable){const t=e.inscrits_actuels>=e.nb_max,i=this.isUserRegistered(e.poste_id);if(t&&!i)return!1}if(this.showMyInscriptions){if(this.selectedVolunteerId){if(!this.isProfileRegistered(e.poste_id,this.selectedVolunteerId))return!1}else if(!this.isUserRegistered(e.poste_id))return!1}return!0})},groupedPostes(){const e={};return this.filteredPostes().forEach(t=>{e[t.periode]||(e[t.periode]=[]),e[t.periode].push(t)}),Object.keys(e).map(t=>{const i=e[t],s=i.length>0&&i[0].periode_ordre||0;let r=[];this.showMyInscriptions?r=[{id:"all",title:"",expanded:!0,postes:[...i].sort((o,a)=>new Date(o.periode_debut)-new Date(a.periode_debut))}]:(r=[{id:"critical",title:"âš ï¸ Postes Prioritaires (Manque de bÃ©nÃ©voles)",expanded:!0,postes:[]},{id:"open",title:"âœ… Inscriptions Ouvertes",expanded:!0,postes:[]},{id:"full",title:"ðŸ”’ Postes Complets",expanded:!1,postes:[]}],i.forEach(o=>{const a=o.nb_min||0,l=o.nb_max||0,d=o.inscrits_actuels||0;d<a?r[0].postes.push(o):d>=l?r[2].postes.push(o):r[1].postes.push(o)}),r.forEach(o=>{o.postes.sort((a,l)=>new Date(a.periode_debut)-new Date(l.periode_debut))}));const n=r.filter(o=>o.postes.length>0);return{name:t,subgroups:n,order:s,totalPostes:i.length,totalInscrits:i.reduce((o,a)=>o+a.inscrits_actuels,0),totalMax:i.reduce((o,a)=>o+a.nb_max,0)}}).sort((t,i)=>t.order-i.order)},initPlanningResponsive(){window.addEventListener("resize",()=>{window.innerWidth>=768?this.viewMode!=="week"&&(this.viewMode="week"):this.viewMode!=="list"&&(this.viewMode="list")})}},I={wizardOpen:!1,wizardStep:1,wizardSelectedProfileId:"",wizardPeriodIndex:0,wizardSelections:[],wizardRemovals:[],showWizardProfileForm:!1,showPostCreationModal:!1,modalTitle:"",wizardProfileForm:{prenom:"",nom:"",telephone:"",taille_tshirt:""},getWizardPeriods(){return!this.postes||this.postes.length===0?[]:[...new Set(this.postes.map(t=>t.periode))].sort((t,i)=>{const s=this.postes.find(n=>n.periode===t),r=this.postes.find(n=>n.periode===i);return(s?.periode_ordre||0)-(r?.periode_ordre||0)})},getCurrentWizardPeriodName(){const e=this.getWizardPeriods();return e.length&&e[this.wizardPeriodIndex]||""},getWizardGroups(){const e=this.getCurrentWizardPeriodName();if(!e)return[];const t=this.postes.filter(s=>s.periode===e),i=[{id:"critical",title:"âš ï¸ Postes Prioritaires (Manque de bÃ©nÃ©voles)",expanded:!0,postes:[]},{id:"open",title:"âœ… Inscriptions Ouvertes",expanded:!0,postes:[]},{id:"full",title:"ðŸ”’ Postes Complets",expanded:!1,postes:[]}];return t.forEach(s=>{const r=s.nb_min||0,n=s.nb_max||0,o=s.inscrits_actuels||0;o<r?i[0].postes.push(s):o>=n?i[2].postes.push(s):i[1].postes.push(s)}),i.forEach(s=>s.postes.sort((r,n)=>new Date(r.periode_debut)-new Date(n.periode_debut))),i.filter(s=>s.postes.length>0)},openWizard(){this.wizardOpen=!0,this.wizardStep=1,this.wizardPeriodIndex=0,this.showPostCreationModal=!1,this.profiles&&this.profiles.length===1&&(this.wizardSelectedProfileId=this.profiles[0].id)},async openWizardWithContext(e,t,i="register"){this.openWizard(),this.profiles&&this.profiles.length>0&&(this.wizardStep=2);const s=this.postes.find(r=>r.poste_id===e);if(s){const n=this.getWizardPeriods().indexOf(s.periode);n!==-1&&(this.wizardPeriodIndex=n);let o=t;!o&&this.profiles.length===1&&(o=this.profiles[0].id),o?i==="register"?await this.wizardRegister(e,o):i==="unregister"&&this.wizardUnregister(e,o):i==="register"&&this.showToast("Veuillez sÃ©lectionner le bÃ©nÃ©vole pour ce poste.","info")}},closeWizard(){if(this.wizardSelections.length>0||this.wizardRemovals.length>0){if(!confirm("Attention, vos choix dans l'assistant seront perdus. Continuer ?"))return;this.wizardRemovals.forEach(e=>{const[t]=e.split("::"),i=this.postes.find(s=>s.poste_id==t);i&&i.inscrits_actuels++}),this.wizardSelections.forEach(e=>{const t=this.postes.find(i=>i.poste_id==e.posteId);t&&t.inscrits_actuels--})}this.resetWizard(),this.wizardOpen=!1,this.loadPostes()},resetWizard(){this.wizardSelections=[],this.wizardRemovals=[],this.wizardStep=1,this.wizardSelectedProfileId="",this.wizardPeriodIndex=0,this.showPostCreationModal=!1},toggleWizardProfile(e){this.wizardSelectedProfileId=e},validateStep1(){return this.wizardSelectedProfileId?!0:(this.showToast("Veuillez sÃ©lectionner un profil.","error"),!1)},prevPeriod(){this.wizardPeriodIndex>0&&this.wizardPeriodIndex--},nextPeriod(){this.wizardPeriodIndex<this.getWizardPeriods().length-1&&this.wizardPeriodIndex++},async createProfileAndContinue(){if(!this.user)return;const e=this.wizardProfileForm;if(!e.prenom||!e.nom||!e.telephone||!e.taille_tshirt){this.showToast("âŒ Veuillez remplir tous les champs","error");return}this.loading=!0;const t=setTimeout(()=>{this.loading&&(this.loading=!1,this.showToast("âŒ Le serveur met du temps Ã  rÃ©pondre. Veuillez rÃ©essayer.","error"))},8e3);try{const{data:i,error:s}=await u.upsert("benevoles",{user_id:this.user.id,email:this.user.email,prenom:e.prenom,nom:e.nom,telephone:e.telephone,taille_tshirt:e.taille_tshirt},{select:"*"});if(s)throw s;this.showToast("âœ… Profil crÃ©Ã© !","success"),await this.loadProfiles();const r=i&&i.length>0?i[0].id:null;r&&(this.wizardSelectedProfileId=r),this.showPostCreationModal=!0,this.showWizardProfileForm=!1,clearTimeout(t)}catch(i){clearTimeout(t),this.showToast("âŒ Erreur : "+i.message,"error"),this.loading=!1}finally{this.showPostCreationModal||(this.loading=!1)}},handlePostProfileCreation(e){this.loading=!1,this.showPostCreationModal=!1,e==="add"?(this.wizardProfileForm={prenom:"",nom:"",telephone:"",taille_tshirt:""},this.showWizardProfileForm=!0):this.wizardStep=2},async wizardRegister(e,t){try{const i=`${e}::${t}`;if(this.wizardSelections.some(r=>r.key===i))return;const s=this.postes.find(r=>r.poste_id===e);if(!s)return;if(s.inscrits_actuels>=s.nb_max){this.showToast("Ce poste est complet.","error");return}if(s.inscrits_actuels>=s.nb_min){const r=new Date(s.periode_debut).getTime(),n=new Date(s.periode_fin).getTime();if(this.postes.some(a=>{if(a.poste_id===s.poste_id)return!1;const l=new Date(a.periode_debut).getTime(),d=new Date(a.periode_fin).getTime();return Math.abs(l-r)<6e4&&Math.abs(d-n)<6e4&&a.inscrits_actuels<a.nb_min})&&typeof this.askConfirm=="function"&&!await this.askConfirm("Le nombre minimum de bÃ©nÃ©voles pour ce poste est dÃ©jÃ  atteint, alors que d'autres postes sur ce crÃ©neau horaire ont encore besoin de monde. ÃŠtes-vous sÃ»r de vouloir maintenir ce choix ?","Attention : Besoins prioritaires"))return}this.wizardRemovals.includes(i)?this.wizardRemovals=this.wizardRemovals.filter(r=>r!==i):this.wizardSelections.push({key:i,posteId:e,profileId:t,posteTitle:s.titre,debut:s.periode_debut,fin:s.periode_fin,profileName:this.profiles.find(r=>r.id===t)?.prenom}),s.inscrits_actuels++,console.log("âœ… Registered (Wizard Array)",i)}catch(i){console.error(i),alert("Erreur: "+i.message)}},wizardUnregister(e,t){const i=`${e}::${t}`,s=this.wizardSelections.findIndex(r=>r.key===i);if(s!==-1){this.wizardSelections.splice(s,1);const r=this.postes.find(n=>n.poste_id===e);r&&r.inscrits_actuels--;return}if(!this.wizardRemovals.includes(i)){this.wizardRemovals.push(i);const r=this.postes.find(n=>n.poste_id===e);r&&r.inscrits_actuels--}},getRemovalDetailsList(){return this.wizardRemovals.map(e=>{const[t,i]=e.split("::"),s=this.postes.find(n=>n.poste_id==t),r=this.profiles.find(n=>n.id==i);return{key:e,posteId:t,profileId:i,posteTitle:s?s.titre:"inconnu",profileName:r?r.prenom:"inconnu",debut:s?s.periode_debut:null,fin:s?s.periode_fin:null}})},async submitWizard(){if(console.log("ðŸš€ submitWizard START"),this.wizardSelections.length===0&&this.wizardRemovals.length===0){this.showToast("Aucune modification Ã  enregistrer.","info");return}this.loading=!0;const e=setTimeout(()=>{this.loading&&(console.error("â° Safety Timeout Triggered"),this.loading=!1,this.showToast("âŒ Le serveur ne rÃ©pond pas (Timeout).","error"))},1e4);try{console.log("ðŸ’¾ Submitting Wizard (Arrays)...",{add:this.wizardSelections.length,remove:this.wizardRemovals.length});const t=[],i=async(s,r)=>{let n;const o=new Promise((a,l)=>{n=setTimeout(()=>l(new Error("Request timed out (20s)")),2e4)});try{console.log(`ðŸ“¡ Sending ${r}...`);const a=await Promise.race([s,o]);if(clearTimeout(n),a&&a.error)throw console.error("âŒ API Error in "+r,a.error),new Error(a.error.message||JSON.stringify(a.error));return console.log(`âœ… Success ${r}`),a}catch(a){throw clearTimeout(n),console.error("âŒ Exception in "+r,a),a}};this.wizardRemovals.forEach(s=>{const[r,n]=s.split("::");console.log("ðŸ—‘ï¸ Queueing DELETE:",{posteId:r,profileId:n}),t.push(i(u.delete("inscriptions",{poste_id:r,benevole_id:n}),`DELETE ${r}::${n}`))}),this.wizardSelections.forEach(s=>{console.log("ðŸ’¾ Queueing UPSERT:",{id:s.posteId,profile:s.profileId}),t.push(i(u.upsert("inscriptions",{poste_id:s.posteId,benevole_id:s.profileId}),`UPSERT ${s.posteId}::${s.profileId}`))}),console.log("â³ Awaiting promises...",t.length),await Promise.all(t),console.log("âœ… All promises resolved"),this.showToast("ðŸŽ‰ Inscriptions mises Ã  jour !","success"),console.log("ðŸ”„ Reloading data..."),await this.loadInitialData(),console.log("âœ… Data reloaded"),this.resetWizard(),this.closeWizard(),clearTimeout(e)}catch(t){console.error("ðŸ’¥ Submit Error Caught:",t),clearTimeout(e),this.showToast("Erreur: "+(t.message||t),"error")}finally{console.log("ðŸ submitWizard FINALLY"),this.loading=!1}},checkWizardAutoOpen(){(!this.userInscriptions||this.userInscriptions.length===0)&&(this.openWizard(),console.log("ðŸª„ Wizard auto-opened (No inscriptions)"))}};function T(){_.data("app",()=>({user:null,loading:!1,toasts:[],confirmModal:{open:!1,title:"",message:"",resolve:null},askConfirm(e,t="Confirmation"){return this.confirmModal.title=t,this.confirmModal.message=e,this.confirmModal.open=!0,new Promise(i=>{this.confirmModal.resolve=i})},handleConfirm(e){this.confirmModal.open=!1,this.confirmModal.resolve&&(this.confirmModal.resolve(e),this.confirmModal.resolve=null)},...S,...E,...I,async init(){try{const e=window.location.hash;if(e&&e.includes("error=")){const s=new URLSearchParams(e.substring(1)),r=s.get("error_description"),n=s.get("error_code");if(r){let o=r.replace(/\+/g," ");n==="otp_expired"&&(o="Ce lien de connexion a expirÃ©. Veuillez en demander un nouveau."),setTimeout(()=>this.showToast("âŒ "+o,"error"),500),window.history.replaceState(null,"",window.location.pathname)}}console.log("ðŸ”„ Init - Checking session...");const t=window.location.hash.includes("access_token")||window.location.hash.includes("type=");let{user:i}=await g.getSession();if(i){if(t)console.log("âœ¨ Magic Link detected. Skipping strict check (Session is fresh).");else{console.log("ðŸ•µï¸â€â™‚ï¸ Existing session found, verifying validity (Strict Mode)...");const{data:s,error:r}=await ApiService.refreshSession();if(r||!s.session){console.warn("â›” Session is invalid or expired:",r),await this.logout(!1);return}console.log("âœ… Session verified & Refreshed."),i=s.session.user}this.user=i,await this.loadInitialData()}g.onAuthStateChange(async(s,r)=>{console.log("ðŸ”” Auth Event:",s),this.user=r?.user||null,s==="SIGNED_IN"||s==="INITIAL_SESSION"?(window.location.hash.includes("access_token")&&(console.log("ðŸ§¹ Cleaning URL hash..."),window.history.replaceState(null,"",window.location.pathname)),await this.loadInitialData()):s==="SIGNED_OUT"&&this.resetData()})}catch(e){console.error("ðŸš¨ Error during app initialization:",e),this.showToast("Erreur d'initialisation: "+e.message,"error")}finally{this.initPlanningResponsive()}},async loadInitialData(){this.user&&(await Promise.all([this.loadProfiles(),this.loadPostes(),this.loadUserInscriptions()]),this.reconcileLocalCounts(),this.checkWizardAutoOpen())},resetData(){this.profiles=[],this.postes=[],this.userInscriptions=[]},loginEmail:"",async sendMagicLink(){if(this.loginEmail){this.loading=!0;try{const{error:e}=await g.signInWithOtp(this.loginEmail);if(e)throw e;this.showToast("ðŸ“§ VÃ©rifiez votre boÃ®te mail !","success"),this.loginEmail=""}catch(e){this.showToast("âŒ Erreur : "+e.message,"error")}finally{this.loading=!1}}},async logout(e=!0){if(!(e&&!await this.askConfirm("Voulez-vous vraiment vous dÃ©connecter ?","DÃ©connexion"))){this.user=null,this.resetData();try{await g.signOut()}catch(t){console.error("Logout error (ignored for UX):",t)}finally{Object.keys(localStorage).forEach(t=>{t.startsWith("sb-")&&localStorage.removeItem(t)}),window.location.reload()}}},showToast(e,t="success"){const i=Date.now()+Math.random().toString(36).substr(2,9);this.toasts.push({id:i,message:e,type:t}),setTimeout(()=>{this.toasts=this.toasts.filter(s=>s.id!==i)},5e3)}}))}T();_.start();
