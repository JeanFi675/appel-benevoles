<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - B√©n√©voles Escalade</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brutal-black': '#000000',
            'brutal-ice': '#8bbfd5',
            'brutal-white': '#ffffff',
          },
          fontFamily: {
            'body': ['Space Grotesk', 'sans-serif'],
            'heading': ['Inter', 'sans-serif'],
          },
          boxShadow: {
            'brutal': '6px 6px 0px #000000',
            'brutal-sm': '4px 4px 0px #000000',
            'brutal-hover': '3px 3px 0px #000000',
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', sans-serif;
    }

    .brutal-btn {
      border: 4px solid #000000;
      font-weight: 700;
      transition: all 0.1s ease;
    }

    .brutal-btn:hover:not(:disabled) {
      box-shadow: 3px 3px 0px #000000;
      transform: translate(3px, 3px);
    }

    .brutal-btn:active:not(:disabled) {
      box-shadow: 1px 1px 0px #000000;
      transform: translate(5px, 5px);
    }

    .brutal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .brutal-card {
      border: 4px solid #000000;
      box-shadow: 6px 6px 0px #000000;
    }

    .brutal-input {
      border: 3px solid #000000;
      font-weight: 600;
    }

    .brutal-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px #8bbfd5;
    }

    .toast {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .tab-button {
      border-bottom: 4px solid transparent;
    }

    .tab-button.active {
      border-bottom-color: #000000;
      background-color: #8bbfd5;
    }
  </style>
</head>

<body class="bg-brutal-ice min-h-screen" x-data="adminApp()" x-init="init()">

  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div class="toast brutal-card px-6 py-4 max-w-md"
           :class="toast.type === 'error' ? 'bg-brutal-black text-brutal-ice' : 'bg-brutal-ice text-brutal-black'">
        <p class="font-bold" x-text="toast.message"></p>
      </div>
    </template>
  </div>

  <!-- Header -->
  <header class="bg-brutal-black text-brutal-white py-8 mb-8 border-b-8 border-brutal-black">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-5xl font-black tracking-tight">
            üîê ADMIN PANEL
          </h1>
          <p class="text-xl font-body mt-2">Gestion des b√©n√©voles et postes</p>
        </div>
        <a href="index.html" class="brutal-btn bg-brutal-ice text-brutal-black px-6 py-3 shadow-brutal-sm">
          ‚Üê Retour
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pb-12">

    <!-- Access Denied -->
    <div x-show="!isAdmin && !loading" class="brutal-card bg-brutal-white p-8 max-w-2xl mx-auto text-center">
      <h2 class="text-3xl font-black mb-4">üö´ Acc√®s refus√©</h2>
      <p class="text-lg font-bold mb-6">Vous n'avez pas les droits d'administrateur.</p>
      <a href="index.html" class="brutal-btn bg-brutal-ice px-6 py-3 shadow-brutal inline-block">
        Retour √† l'accueil
      </a>
    </div>

    <!-- Loading -->
    <div x-show="loading && !isAdmin" class="brutal-card bg-brutal-white p-8 max-w-2xl mx-auto text-center">
      <p class="text-2xl font-black">‚è≥ V√©rification des droits...</p>
    </div>

    <!-- Admin Interface -->
    <div x-show="isAdmin">

      <!-- Tabs -->
      <div class="brutal-card bg-brutal-white mb-8 flex overflow-x-auto">
        <button
          @click="activeTab = 'postes'"
          class="tab-button px-8 py-4 font-black text-lg"
          :class="{ 'active': activeTab === 'postes' }"
        >
          üìã Postes
        </button>
        <button
          @click="activeTab = 'periodes'"
          class="tab-button px-8 py-4 font-black text-lg"
          :class="{ 'active': activeTab === 'periodes' }"
        >
          üìÖ P√©riodes
        </button>
        <button
          @click="activeTab = 'benevoles'"
          class="tab-button px-8 py-4 font-black text-lg"
          :class="{ 'active': activeTab === 'benevoles' }"
        >
          üë• B√©n√©voles
        </button>
      </div>

      <!-- Tab: Postes -->
      <div x-show="activeTab === 'postes'">
        <div class="brutal-card bg-brutal-white p-8 mb-8">
          <h2 class="text-3xl font-black mb-6" x-text="editingPoste ? 'Modifier un poste' : 'Ajouter un poste'"></h2>

          <form @submit.prevent="savePoste()">
            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block font-bold mb-2">Titre *</label>
                <input
                  type="text"
                  x-model="posteForm.titre"
                  required
                  class="brutal-input w-full px-4 py-3"
                  placeholder="Juge de bloc"
                />
              </div>

              <div>
                <label class="block font-bold mb-2">P√©riode *</label>
                <select
                  x-model="posteForm.periode_id"
                  required
                  class="brutal-input w-full px-4 py-3 font-bold"
                >
                  <option value="">-- S√©lectionnez une p√©riode --</option>
                  <template x-for="periode in periodes" :key="periode.id">
                    <option :value="periode.id" x-text="periode.nom"></option>
                  </template>
                </select>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block font-bold mb-2">D√©but *</label>
                <input
                  type="datetime-local"
                  x-model="posteForm.periode_debut"
                  required
                  class="brutal-input w-full px-4 py-3"
                />
              </div>

              <div>
                <label class="block font-bold mb-2">Fin *</label>
                <input
                  type="datetime-local"
                  x-model="posteForm.periode_fin"
                  required
                  class="brutal-input w-full px-4 py-3"
                />
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block font-bold mb-2">Minimum *</label>
                <input
                  type="number"
                  x-model.number="posteForm.nb_min"
                  required
                  min="1"
                  class="brutal-input w-full px-4 py-3"
                />
              </div>

              <div>
                <label class="block font-bold mb-2">Maximum *</label>
                <input
                  type="number"
                  x-model.number="posteForm.nb_max"
                  required
                  min="1"
                  class="brutal-input w-full px-4 py-3"
                />
              </div>
            </div>

            <div class="mb-4">
              <label class="block font-bold mb-2">R√©f√©rent</label>
              <select
                x-model="posteForm.referent_id"
                class="brutal-input w-full px-4 py-3 font-bold"
              >
                <option value="">-- Aucun r√©f√©rent --</option>
                <template x-for="benevole in benevoles" :key="benevole.id">
                  <option :value="benevole.id" x-text="benevole.prenom + ' ' + benevole.nom"></option>
                </template>
              </select>
            </div>

            <div class="mb-6">
              <label class="block font-bold mb-2">Description</label>
              <textarea
                x-model="posteForm.description"
                class="brutal-input w-full px-4 py-3"
                rows="3"
                placeholder="D√©tails du poste..."
              ></textarea>
            </div>

            <div class="flex gap-4">
              <button
                type="submit"
                :disabled="loading"
                class="brutal-btn bg-brutal-ice flex-1 py-4 text-xl shadow-brutal"
              >
                <span x-show="!loading" x-text="editingPoste ? 'üíæ Enregistrer' : '‚úÖ Cr√©er le poste'"></span>
                <span x-show="loading">‚è≥ Enregistrement...</span>
              </button>

              <button
                x-show="editingPoste"
                type="button"
                @click="cancelEdit()"
                class="brutal-btn bg-gray-300 px-6 py-4 text-xl shadow-brutal"
              >
                ‚ùå Annuler
              </button>
            </div>
          </form>
        </div>

        <!-- Liste des postes -->
        <div class="brutal-card bg-brutal-white p-8">
          <h2 class="text-3xl font-black mb-6">Liste des postes</h2>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b-4 border-brutal-black">
                  <th class="text-left py-3 px-2 font-black">Titre</th>
                  <th class="text-left py-3 px-2 font-black">P√©riode</th>
                  <th class="text-left py-3 px-2 font-black">Horaires</th>
                  <th class="text-left py-3 px-2 font-black">Min / Max</th>
                  <th class="text-left py-3 px-2 font-black">Inscrits</th>
                  <th class="text-left py-3 px-2 font-black">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="poste in postes" :key="poste.id">
                  <tr class="border-b-2 border-gray-300">
                    <td class="py-3 px-2 font-bold" x-text="poste.titre"></td>
                    <td class="py-3 px-2 font-bold" x-text="poste.periode_nom"></td>
                    <td class="py-3 px-2 font-bold text-sm">
                      <span x-text="formatDateTime(poste.periode_debut)"></span><br>
                      <span x-text="formatDateTime(poste.periode_fin)"></span>
                    </td>
                    <td class="py-3 px-2 font-bold text-center">
                      <span x-text="poste.nb_min"></span> / <span x-text="poste.nb_max"></span>
                    </td>
                    <td class="py-3 px-2 font-bold text-center">
                      <span x-text="poste.inscrits_actuels || 0"></span>
                    </td>
                    <td class="py-3 px-2">
                      <div class="flex gap-2">
                        <button
                          @click="editPoste(poste)"
                          class="brutal-btn bg-brutal-ice px-4 py-2 shadow-brutal-sm text-sm"
                        >
                          ‚úèÔ∏è Modifier
                        </button>
                        <button
                          @click="deletePoste(poste.id)"
                          class="brutal-btn bg-red-500 text-white px-4 py-2 shadow-brutal-sm text-sm"
                        >
                          üóëÔ∏è Supprimer
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab: P√©riodes -->
      <div x-show="activeTab === 'periodes'">
        <div class="brutal-card bg-brutal-white p-8 mb-8">
          <h2 class="text-3xl font-black mb-6">Ajouter une p√©riode</h2>

          <form @submit.prevent="createPeriode()">
            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block font-bold mb-2">Nom *</label>
                <input
                  type="text"
                  x-model="periodeForm.nom"
                  required
                  class="brutal-input w-full px-4 py-3"
                  placeholder="Qualifications Samedi"
                />
              </div>

              <div>
                <label class="block font-bold mb-2">Ordre d'affichage *</label>
                <input
                  type="number"
                  x-model.number="periodeForm.ordre"
                  required
                  min="1"
                  class="brutal-input w-full px-4 py-3"
                />
                <p class="text-sm mt-1">Les p√©riodes sont affich√©es dans l'ordre croissant</p>
              </div>
            </div>

            <button
              type="submit"
              :disabled="loading"
              class="brutal-btn bg-brutal-ice w-full py-4 text-xl shadow-brutal"
            >
              <span x-show="!loading">‚úÖ Cr√©er la p√©riode</span>
              <span x-show="loading">‚è≥ Cr√©ation...</span>
            </button>
          </form>
        </div>

        <!-- Liste des p√©riodes -->
        <div class="brutal-card bg-brutal-white p-8">
          <h2 class="text-3xl font-black mb-6">Liste des p√©riodes</h2>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b-4 border-brutal-black">
                  <th class="text-left py-3 px-2 font-black">Ordre</th>
                  <th class="text-left py-3 px-2 font-black">Nom</th>
                  <th class="text-left py-3 px-2 font-black">Nb postes</th>
                  <th class="text-left py-3 px-2 font-black">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="periode in periodes" :key="periode.id">
                  <tr class="border-b-2 border-gray-300">
                    <td class="py-3 px-2">
                      <input
                        type="number"
                        :value="periode.ordre"
                        @change="updatePeriodeOrder(periode.id, $event.target.value)"
                        class="brutal-input w-20 px-2 py-1 text-center font-black"
                        min="1"
                      />
                    </td>
                    <td class="py-3 px-2 font-bold" x-text="periode.nom"></td>
                    <td class="py-3 px-2 font-bold text-center">
                      <span x-text="getPostesCountForPeriode(periode.id)"></span>
                    </td>
                    <td class="py-3 px-2">
                      <button
                        @click="deletePeriode(periode.id)"
                        :disabled="getPostesCountForPeriode(periode.id) > 0"
                        class="brutal-btn px-4 py-2 shadow-brutal-sm text-sm"
                        :class="getPostesCountForPeriode(periode.id) > 0 ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-red-500 text-white'"
                      >
                        üóëÔ∏è Supprimer
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <div class="mt-6 p-4 bg-yellow-100 border-3 border-brutal-black">
            <p class="font-bold">
              üí° <strong>Note :</strong> Vous ne pouvez pas supprimer une p√©riode qui contient des postes. Supprimez d'abord tous les postes de la p√©riode.
            </p>
          </div>
        </div>
      </div>

      <!-- Tab: B√©n√©voles -->
      <div x-show="activeTab === 'benevoles'">
        <div class="brutal-card bg-brutal-white p-8">
          <h2 class="text-3xl font-black mb-6">Liste des b√©n√©voles</h2>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b-4 border-brutal-black">
                  <th class="text-left py-3 px-2 font-black">Nom</th>
                  <th class="text-left py-3 px-2 font-black">Email</th>
                  <th class="text-left py-3 px-2 font-black">T√©l√©phone</th>
                  <th class="text-left py-3 px-2 font-black">T-shirt</th>
                  <th class="text-left py-3 px-2 font-black">Inscriptions</th>
                  <th class="text-left py-3 px-2 font-black">Postes r√©f√©rent</th>
                  <th class="text-left py-3 px-2 font-black">R√¥le</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="benevole in benevoles" :key="benevole.id">
                  <tr class="border-b-2 border-gray-300">
                    <td class="py-3 px-2 font-bold">
                      <span x-text="benevole.prenom + ' ' + benevole.nom"></span>
                    </td>
                    <td class="py-3 px-2 font-bold text-sm" x-text="benevole.email"></td>
                    <td class="py-3 px-2 font-bold" x-text="benevole.telephone || '-'"></td>
                    <td class="py-3 px-2 font-bold" x-text="benevole.taille_tshirt"></td>
                    <td class="py-3 px-2 font-bold text-center" x-text="benevole.nb_inscriptions"></td>
                    <td class="py-3 px-2 font-bold text-center" x-text="benevole.nb_postes_referent || 0"></td>
                    <td class="py-3 px-2">
                      <template x-if="benevole.role === 'admin'">
                        <span class="px-3 py-1 font-bold text-sm border-3 border-brutal-black bg-brutal-black text-brutal-white">
                          üîê Admin
                        </span>
                      </template>
                      <template x-if="benevole.role !== 'admin'">
                        <select
                          :value="benevole.role"
                          @change="updateBenevoleRole(benevole.id, $event.target.value)"
                          class="brutal-input px-3 py-1 text-sm font-bold"
                          :class="{
                            'bg-brutal-ice text-brutal-black': benevole.role === 'referent',
                            'bg-gray-200 text-brutal-black': benevole.role === 'benevole'
                          }"
                        >
                          <option value="benevole">üë§ B√©n√©vole</option>
                          <option value="referent">üëî R√©f√©rent</option>
                        </select>
                      </template>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <div class="mt-6 p-4 bg-blue-100 border-3 border-brutal-black">
            <p class="font-bold">
              üí° <strong>R√¥les :</strong>
            </p>
            <ul class="mt-2 list-disc list-inside font-bold text-sm">
              <li><strong>üë§ B√©n√©vole :</strong> Peut s'inscrire aux postes</li>
              <li><strong>üëî R√©f√©rent :</strong> Peut √™tre d√©sign√© comme r√©f√©rent d'un poste</li>
              <li><strong>üîê Admin :</strong> Acc√®s complet √† l'administration (√† d√©finir via Supabase SQL uniquement)</li>
            </ul>
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- Alpine.js via CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Supabase Client via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Variables d'environnement Vite -->
  <script>
    window.ENV = {
      VITE_SUPABASE_URL: '%VITE_SUPABASE_URL%',
      VITE_SUPABASE_ANON_KEY: '%VITE_SUPABASE_ANON_KEY%',
      VITE_APP_URL_LOCAL: '%VITE_APP_URL_LOCAL%',
      VITE_APP_URL_PRODUCTION: '%VITE_APP_URL_PRODUCTION%'
    };
  </script>

  <!-- Configuration Partag√©e -->
  <script src="/config.js"></script>

  <!-- Application Logic -->
  <script>
    // Utilise la configuration partag√©e depuis config.js
    const { supabase, getMagicLinkRedirectUrl } = window.appConfig;

    function adminApp() {
      return {
        isAdmin: false,
        loading: true,
        activeTab: 'postes',
        toasts: [],

        postes: [],
        benevoles: [],
        periodes: [],
        editingPoste: null,

        posteForm: {
          titre: '',
          periode_id: '',
          periode_debut: '',
          periode_fin: '',
          referent_id: '',
          description: '',
          nb_min: 1,
          nb_max: 5
        },

        periodeForm: {
          nom: '',
          ordre: 1
        },

        async init() {
          // Check authentication and admin status
          const { data: { session } } = await supabase.auth.getSession();

          if (!session) {
            window.location.href = 'index.html';
            return;
          }

          // Check if user is admin
          const { data: profile, error } = await supabase
            .from('benevoles')
            .select('role')
            .eq('id', session.user.id)
            .single();

          if (error || !profile || profile.role !== 'admin') {
            this.isAdmin = false;
            this.loading = false;
            return;
          }

          this.isAdmin = true;
          this.loading = false;

          await this.loadData();
        },

        async loadData() {
          await Promise.all([
            this.loadPostes(),
            this.loadBenevoles(),
            this.loadPeriodes()
          ]);
        },

        async loadPostes() {
          try {
            const { data, error } = await supabase
              .from('postes')
              .select('*, periodes(nom, ordre)');

            if (error) throw error;

            // Count inscriptions for each poste
            const postesWithCounts = await Promise.all(
              (data || []).map(async (poste) => {
                const { count } = await supabase
                  .from('inscriptions')
                  .select('*', { count: 'exact', head: true })
                  .eq('poste_id', poste.id);

                return {
                  ...poste,
                  periode_nom: poste.periodes?.nom || '-',
                  periode_ordre: poste.periodes?.ordre || 999,
                  inscrits_actuels: count || 0
                };
              })
            );

            // Sort by periode order, then by start date
            this.postes = postesWithCounts.sort((a, b) => {
              if (a.periode_ordre !== b.periode_ordre) {
                return a.periode_ordre - b.periode_ordre;
              }
              return new Date(a.periode_debut) - new Date(b.periode_debut);
            });
          } catch (error) {
            this.showToast('‚ùå Erreur chargement postes : ' + error.message, 'error');
          }
        },

        async loadBenevoles() {
          try {
            const { data, error } = await supabase
              .from('admin_benevoles')
              .select('*')
              .order('nom');

            if (error) throw error;
            this.benevoles = data || [];
          } catch (error) {
            this.showToast('‚ùå Erreur chargement b√©n√©voles : ' + error.message, 'error');
          }
        },

        async loadPeriodes() {
          try {
            const { data, error } = await supabase
              .from('periodes')
              .select('*')
              .order('ordre');

            if (error) throw error;
            this.periodes = data || [];
          } catch (error) {
            this.showToast('‚ùå Erreur chargement p√©riodes : ' + error.message, 'error');
          }
        },

        async savePoste() {
          this.loading = true;
          try {
            if (this.editingPoste) {
              // Update existing poste
              const { error } = await supabase
                .from('postes')
                .update(this.posteForm)
                .eq('id', this.editingPoste.id);

              if (error) throw error;
              this.showToast('‚úÖ Poste modifi√© avec succ√®s !', 'success');
            } else {
              // Create new poste
              const { error } = await supabase
                .from('postes')
                .insert([this.posteForm]);

              if (error) throw error;
              this.showToast('‚úÖ Poste cr√©√© avec succ√®s !', 'success');
            }

            // Reset form
            this.editingPoste = null;
            this.posteForm = {
              titre: '',
              periode_id: '',
              periode_debut: '',
              periode_fin: '',
              referent_id: '',
              description: '',
              nb_min: 1,
              nb_max: 5
            };

            await this.loadPostes();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
          } finally {
            this.loading = false;
          }
        },

        editPoste(poste) {
          this.editingPoste = poste;
          this.posteForm = {
            titre: poste.titre,
            periode_id: poste.periode_id,
            periode_debut: this.formatDateTimeForInput(poste.periode_debut),
            periode_fin: this.formatDateTimeForInput(poste.periode_fin),
            referent_id: poste.referent_id || '',
            description: poste.description || '',
            nb_min: poste.nb_min,
            nb_max: poste.nb_max
          };

          // Scroll to form
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        cancelEdit() {
          this.editingPoste = null;
          this.posteForm = {
            titre: '',
            periode_id: '',
            periode_debut: '',
            periode_fin: '',
            referent_id: '',
            description: '',
            nb_min: 1,
            nb_max: 5
          };
        },

        async deletePoste(id) {
          if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce poste ?')) return;

          this.loading = true;
          try {
            const { error } = await supabase
              .from('postes')
              .delete()
              .eq('id', id);

            if (error) throw error;

            this.showToast('‚úÖ Poste supprim√©', 'success');
            await this.loadPostes();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
          } finally {
            this.loading = false;
          }
        },

        async createPeriode() {
          this.loading = true;
          try {
            const { error } = await supabase
              .from('periodes')
              .insert([this.periodeForm]);

            if (error) throw error;

            this.showToast('‚úÖ P√©riode cr√©√©e avec succ√®s !', 'success');

            // Reset form
            this.periodeForm = {
              nom: '',
              ordre: this.periodes.length + 1
            };

            await this.loadPeriodes();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
          } finally {
            this.loading = false;
          }
        },

        async updatePeriodeOrder(periodeId, newOrder) {
          try {
            const { error } = await supabase
              .from('periodes')
              .update({ ordre: parseInt(newOrder) })
              .eq('id', periodeId);

            if (error) throw error;

            this.showToast('‚úÖ Ordre mis √† jour', 'success');
            await this.loadPeriodes();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
          }
        },

        async deletePeriode(periodeId) {
          if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette p√©riode ?')) return;

          this.loading = true;
          try {
            const { error } = await supabase
              .from('periodes')
              .delete()
              .eq('id', periodeId);

            if (error) throw error;

            this.showToast('‚úÖ P√©riode supprim√©e', 'success');
            await this.loadPeriodes();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
          } finally {
            this.loading = false;
          }
        },

        getPostesCountForPeriode(periodeId) {
          return this.postes.filter(p => p.periode_id === periodeId).length;
        },

        async updateBenevoleRole(benevoleId, newRole) {
          try {
            const { error } = await supabase
              .from('benevoles')
              .update({ role: newRole })
              .eq('id', benevoleId);

            if (error) throw error;

            const roleNames = {
              'benevole': 'B√©n√©vole',
              'referent': 'R√©f√©rent',
              'admin': 'Admin'
            };

            this.showToast(`‚úÖ R√¥le chang√© en ${roleNames[newRole]}`, 'success');
            await this.loadBenevoles();
          } catch (error) {
            this.showToast('‚ùå Erreur : ' + error.message, 'error');
            await this.loadBenevoles(); // Reload to reset the select
          }
        },

        formatDateTime(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('fr-FR', {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
          });
        },

        formatDateTimeForInput(dateString) {
          const date = new Date(dateString);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        },

        showToast(message, type = 'success') {
          const id = Date.now();
          this.toasts.push({ id, message, type });

          setTimeout(() => {
            this.toasts = this.toasts.filter(t => t.id !== id);
          }, 5000);
        }
      }
    }
  </script>

</body>
</html>
