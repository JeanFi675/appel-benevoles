<div x-show="wizardOpen"
    class="fixed inset-0 z-50 flex items-center justify-center bg-brutal-black/90 backdrop-blur-sm p-4 overflow-y-auto"
    x-transition.opacity style="display: none;">

    <div class="brutal-card bg-brutal-white w-full max-w-5xl relative flex flex-col max-h-[90vh]">
        <!-- Header Wizard -->
        <div
            class="border-b-4 border-brutal-black p-4 flex justify-between items-center bg-brutal-ice sticky top-0 z-10">
            <div>
                <h2 class="text-2xl font-black uppercase">Assistant d'inscription</h2>
                <div class="flex items-center gap-2 text-sm font-bold text-gray-600">
                    <span :class="{'text-black underline': wizardStep === 1}">1. Profil</span>
                    <span>‚Üí</span>
                    <span :class="{'text-black underline': wizardStep === 2}">2. Choix des Postes</span>
                    <span>‚Üí</span>
                    <span :class="{'text-black underline': wizardStep === 3}">3. Confirmation</span>
                </div>
            </div>
            <button @click="closeWizard()"
                class="brutal-btn p-2 text-xl hover:bg-red-500 hover:text-white transition-colors">
                ‚úï
            </button>
        </div>

        <!-- Content Scroller -->
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">

            <!-- STEP 1: PROFIL -->
            <div x-show="wizardStep === 1" class="text-center max-w-2xl mx-auto">
                <!-- h3 removed per user request -->

                <!-- NEW: EMBEDDED PROFILE FORM -->
                <div x-show="profiles.length === 0 || showWizardProfileForm"
                    class="mb-8 p-6 text-left max-w-lg mx-auto bg-white border-2 border-brutal-black shadow-brutal">
                    <h4 class="text-xl font-black mb-4 uppercase bg-yellow-400 inline-block px-2">Nouveau B√©n√©vole</h4>

                    <div class="space-y-4">
                        <div>
                            <label class="block font-bold mb-1">Pr√©nom *</label>
                            <input type="text" x-model="wizardProfileForm.prenom"
                                class="w-full border-2 border-brutal-black p-2 font-bold focus:shadow-brutal focus:outline-none">
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Nom *</label>
                            <input type="text" x-model="wizardProfileForm.nom"
                                class="w-full border-2 border-brutal-black p-2 font-bold focus:shadow-brutal focus:outline-none">
                        </div>
                        <div>
                            <label class="block font-bold mb-1">T√©l√©phone *</label>
                            <input type="tel" x-model="wizardProfileForm.telephone"
                                class="w-full border-2 border-brutal-black p-2 font-bold focus:shadow-brutal focus:outline-none">
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Taille T-Shirt *</label>
                            <select x-model="wizardProfileForm.taille_tshirt"
                                class="w-full border-2 border-brutal-black p-2 font-bold focus:shadow-brutal focus:outline-none bg-white">
                                <option value="">Choisir...</option>
                                <option value="XS">XS</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                            </select>
                        </div>

                        <div class="flex justify-between items-center mt-6 pt-4 border-t-2 border-gray-100 gap-4">
                            <button x-show="profiles.length > 0" @click="showWizardProfileForm = false"
                                class="brutal-btn bg-white text-brutal-black border-2 border-brutal-black px-6 py-2 font-bold shadow-brutal hover:bg-gray-100 uppercase text-sm">
                                Annuler
                            </button>
                            <button @click="createProfileAndContinue()"
                                class="brutal-btn bg-brutal-black text-brutal-white px-6 py-2 w-full shadow-brutal hover:bg-gray-800 disabled:opacity-50"
                                :class="{'w-auto': profiles.length > 0}" :disabled="loading">
                                <span x-show="!loading">Enregistrer & Continuer</span>
                                <span x-show="loading">...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NEW: POST-CREATION CHOICES NODAL (Overlay on Step 1) -->
                <div x-show="showPostCreationModal"
                    class="absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center p-8 text-center"
                    x-transition.opacity>

                    <div
                        class="brutal-card bg-brutal-ice p-8 border-4 border-brutal-black shadow-brutal max-w-lg w-full">
                        <h4 class="text-3xl font-black mb-6 uppercase" x-text="modalTitle || 'Profil Cr√©√© ! ‚úÖ'"></h4>
                        <p class="font-bold text-xl mb-8">Que souhaitez-vous faire maintenant ?</p>

                        <div class="flex flex-col gap-4">
                            <button @click="handlePostProfileCreation('add')"
                                class="brutal-btn bg-white text-brutal-black px-6 py-4 border-2 border-brutal-black font-bold hover:bg-gray-100 flex items-center justify-center gap-2">
                                <span>‚ûï</span> Ajouter un autre b√©n√©vole <br><span class="text-xs font-normal">(ex:
                                    conjoint, enfant...)</span>
                            </button>

                            <button @click="handlePostProfileCreation('continue')"
                                class="brutal-btn bg-brutal-black text-brutal-white px-6 py-4 font-bold shadow-brutal hover:bg-gray-800 flex items-center justify-center gap-2">
                                <span>üöÄ</span> Continuer vers le choix des Postes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Existing Profiles List -->
                <div x-show="profiles.length > 0 && !showWizardProfileForm" class="grid gap-4">
                    <p class="font-bold text-xl mb-4">Vos b√©n√©voles enregistr√©s :</p>
                    <template x-for="profile in profiles" :key="profile.id">
                        <div class="brutal-card p-4 flex items-center justify-between group bg-white cursor-pointer hover:bg-gray-50 transition-colors"
                            :class="{'border-l-8 border-l-brutal-black': wizardSelectedProfileId === profile.id}"
                            @click="toggleWizardProfile(profile.id)">
                            <div class="flex items-center gap-4 w-full">
                                <span class="font-black text-xl w-full text-center"
                                    x-text="profile.prenom + ' ' + profile.nom"></span>
                            </div>
                        </div>
                    </template>
                    <!-- 'Ajouter un autre b√©n√©vole' link removed per user request -->
                </div>
            </div>

            <!-- STEP 2: PERIODES -->
            <div x-show="wizardStep === 2">
                <!-- Navigation P√©riodes -->
                <div
                    class="flex justify-between items-center mb-6 bg-brutal-black text-brutal-white p-3 rounded-none shadow-brutal-sm">
                    <button @click="prevPeriod()"
                        class="brutal-btn bg-white text-black px-4 py-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="wizardPeriodIndex === 0">
                        ‚Üê Pr√©c√©dent
                    </button>

                    <h3 class="text-xl font-black uppercase text-center" x-text="getCurrentWizardPeriodName()"></h3>

                    <button @click="nextPeriod()"
                        class="brutal-btn bg-white text-black px-4 py-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="wizardPeriodIndex >= getWizardPeriods().length - 1">
                        Suivant ‚Üí
                    </button>
                </div>

                <!-- Liste des Postes pour la p√©riode active (GROUP√âE) -->
                <div class="grid gap-6">
                    <template x-for="subgroup in getWizardGroups()" :key="subgroup.id">
                        <div x-data="{ openSub: subgroup.expanded }">
                            <!-- Subgroup Header -->
                            <div @click="openSub = !openSub"
                                class="flex justify-between items-center bg-gray-200 p-3 cursor-pointer select-none border-l-4 border-brutal-black hover:bg-gray-300 transition-colors mb-4">
                                <h4 class="text-lg font-black uppercase text-brutal-black" x-text="subgroup.title"></h4>
                                <div class="text-xl transform transition-transform duration-300"
                                    :class="openSub ? 'rotate-180' : ''">
                                    ‚ñº
                                </div>
                            </div>

                            <!-- Posts inside Subgroup -->
                            <div class="grid gap-6 pl-0 md:pl-2" x-show="openSub" x-transition>
                                <template x-for="poste in subgroup.postes" :key="poste.poste_id">
                                    <div class="wizard-card-wrapper">
                                        <%- include('components/post-card-details.html') %>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <div x-show="getWizardGroups().length === 0" class="text-center py-12 italic text-gray-500">
                        Aucun poste disponible pour cette p√©riode.
                    </div>
                </div>
            </div>

            <!-- STEP 3: CONFIRMATION -->
            <div x-show="wizardStep === 3" class="max-w-3xl mx-auto">
                <h3 class="text-3xl font-black mb-8 text-center">R√©capitulatif de vos choix</h3>

                <!-- Step 3 Content: Summary -->
                <div class="bg-white border-2 border-brutal-black p-6 shadow-brutal mb-8">

                    <!-- ADDITIONS -->
                    <template x-if="wizardSelections.length > 0">
                        <div class="mb-4">
                            <h4 class="font-bold uppercase text-green-600 border-b-2 border-green-600 mb-2">
                                √Ä Ajouter</h4>
                            <div class="grid gap-4">
                                <template x-for="selection in wizardSelections" :key="selection.key">
                                    <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                        <div>
                                            <p class="font-black" x-text="selection.posteTitle"></p>
                                            <p class="text-sm text-gray-600">
                                                <span x-text="formatDate(selection.debut)"></span> ‚Ä¢
                                                <span x-text="formatTime(selection.debut)"></span> -
                                                <span x-text="formatTime(selection.fin)"></span>
                                            </p>
                                            <p class="text-xs font-bold text-blue-600 mt-1">
                                                üë§ pour <span x-text="selection.profileName"></span>
                                            </p>
                                        </div>
                                        <button @click="wizardUnregister(selection.posteId, selection.profileId)"
                                            class="text-red-500 font-bold hover:underline text-sm">
                                            Annuler
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- REMOVALS -->
                    <template x-if="wizardRemovals.length > 0">
                        <div>
                            <h4 class="font-bold uppercase text-red-600 border-b-2 border-red-600 mb-2">
                                √Ä Supprimer</h4>
                            <div class="grid gap-4">
                                <template x-for="rem in getRemovalDetailsList()" :key="rem.key">
                                    <div
                                        class="flex justify-between items-center border-b border-gray-100 pb-2 bg-red-50 p-2">
                                        <div>
                                            <p class="font-black line-through text-gray-500" x-text="rem.posteTitle">
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                <span x-text="formatDate(rem.debut)"></span>
                                            </p>
                                            <p class="text-xs font-bold text-gray-500 mt-1">
                                                üë§ <span x-text="rem.profileName"></span>
                                            </p>
                                        </div>
                                        <!-- Update logic: Filter array instead of .delete() -->
                                        <button
                                            @click="wizardRemovals = wizardRemovals.filter(k => k !== rem.key); loadPostes()"
                                            class="text-green-600 font-bold hover:underline text-sm">
                                            Restaurer
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="wizardSelections.length === 0 && wizardRemovals.length === 0">
                        <p class="text-center italic text-gray-500">Aucun changement pour le moment.
                        </p>
                    </template>
                </div>

                <div class="text-center">
                    <p class="mb-4 font-bold">Tout est bon pour vous ?</p>
                </div>
            </div>

        </div>

        <!-- Footer Navigation -->
        <div
            class="border-t-4 border-brutal-black p-4 bg-gray-100 flex justify-between items-center sticky bottom-0 z-10">
            <div class="flex gap-2">
                <button x-show="wizardStep > 1" @click="wizardStep--"
                    class="brutal-btn bg-white px-6 py-3 border-2 border-brutal-black font-bold">
                    Retour
                </button>
            </div>

            <div>
                <!-- Step 1 Next -->
                <button x-show="wizardStep === 1 && profiles.length > 0 && !showWizardProfileForm"
                    @click="modalTitle = 'C\'est parti !'; showPostCreationModal = true"
                    class="brutal-btn bg-brutal-black text-brutal-white px-8 py-3 font-bold shadow-brutal disabled:opacity-50 disabled:cursor-not-allowed">
                    Continuer ‚Üí
                </button>

                <!-- Step 2 Next -->
                <button x-show="wizardStep === 2" @click="wizardStep = 3"
                    class="brutal-btn bg-yellow-400 text-black px-8 py-3 font-bold shadow-brutal border-2 border-black">
                    V√©rifier et Valider (<span x-text="wizardSelections.length + wizardRemovals.length"></span>)
                </button>

                <!-- Step 3 Submit -->
                <button x-show="wizardStep === 3" @click="submitWizard()"
                    class="brutal-btn bg-green-500 text-white px-8 py-3 font-bold shadow-brutal border-2 border-black disabled:opacity-50"
                    :disabled="(wizardSelections.length === 0 && wizardRemovals.length === 0) || loading">
                    <span x-show="!loading">Valider mes inscriptions üéâ</span>
                    <span x-show="loading">Validation...</span>
                </button>
            </div>
        </div>
    </div>
</div>