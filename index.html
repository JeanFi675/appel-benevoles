<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√©n√©voles Escalade - Inscription</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Main CSS (Tailwind) -->
  <link rel="stylesheet" href="./src/styles/main.css">
</head>

<body class="bg-brutal-ice min-h-screen" x-data="app()" x-init="init()">

  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div class="toast brutal-card px-6 py-4 max-w-md"
        :class="toast.type === 'error' ? 'bg-brutal-black text-brutal-ice' : 'bg-brutal-ice text-brutal-black'">
        <p class="font-bold" x-text="toast.message"></p>
      </div>
    </template>
  </div>

  <!-- Header -->
  <header class="bg-brutal-black text-brutal-white py-8 mb-8 border-b-8 border-brutal-black">
    <div class="container mx-auto px-4">
      <h1 class="text-5xl font-black text-center tracking-tight">
        üßó B√âN√âVOLES ESCALADE
      </h1>
      <p class="text-center mt-2 text-xl font-body">Inscrivez-vous pour aider la comp√©tition</p>
    </div>
  </header>

  <main class="container mx-auto px-4 pb-12">

    <!-- Section Authentification -->
    <section class="mb-12" x-show="!user">
      <div class="max-w-md mx-auto">
        <div class="brutal-card bg-brutal-white p-8">
          <h2 class="text-3xl font-black mb-6">Connexion</h2>

          <form @submit.prevent="sendMagicLink()">
            <div class="mb-4">
              <label for="email" class="block font-bold mb-2 text-lg">Votre email</label>
              <input type="email" id="email" x-model="loginEmail" required placeholder="jean.dupont@example.com"
                class="brutal-input w-full px-4 py-3 text-lg" />
            </div>

            <button type="submit" :disabled="loading"
              class="brutal-btn bg-brutal-ice w-full py-4 text-xl shadow-brutal">
              <span x-show="!loading">üìß Recevoir le lien de connexion</span>
              <span x-show="loading">‚è≥ Envoi en cours...</span>
            </button>
          </form>

          <p class="mt-4 text-sm text-center">
            Vous recevrez un email avec un lien magique pour vous connecter sans mot de passe.
          </p>
        </div>
      </div>
    </section>

    <!-- Section Utilisateur Connect√© -->
    <section x-show="user" style="display: none;">

      <!-- Barre Utilisateur -->
      <div
        class="sticky top-0 z-40 brutal-card bg-brutal-white p-6 mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4 shadow-brutal border-b-4 border-brutal-black">
        <div>
          <p class="text-sm font-bold text-gray-600">Bienvenue,</p>
          <p class="text-2xl font-black" x-text="profile ? profile.prenom : user?.email"></p>
          <span x-show="profile && profile.role === 'admin'"
            class="inline-block mt-2 px-3 py-1 bg-brutal-black text-brutal-white font-bold text-sm border-2 border-brutal-black">
            üîê Administrateur
          </span>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <a x-show="profile && profile.role === 'admin'" href="admin.html"
            class="brutal-btn bg-brutal-ice px-6 py-3 shadow-brutal-sm text-center">
            üîê Admin
          </a>
          <button @click="toggleProfile()"
            class="brutal-btn bg-brutal-white text-brutal-black px-6 py-3 shadow-brutal-sm w-full sm:w-auto border-2 border-brutal-black">
            üë§ Mon Profil
          </button>
          <button @click="logout()"
            class="brutal-btn bg-brutal-black text-brutal-white px-6 py-3 shadow-brutal-sm w-full sm:w-auto">
            Se d√©connecter
          </button>
        </div>
      </div>

      <!-- Formulaire Profil (Premi√®re connexion OU Edition) -->
      <div x-show="user && (!profile || showProfileEdit)" class="brutal-card bg-brutal-white p-8 mb-8">
        <h2 class="text-3xl font-black mb-6" x-text="profile ? 'Mon Profil' : 'Compl√©tez votre profil'"></h2>

        <form @submit.prevent="saveProfile()">
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block font-bold mb-2">Pr√©nom *</label>
              <input type="text" x-model="profileForm.prenom" required class="brutal-input w-full px-4 py-3"
                placeholder="Jean" />
            </div>

            <div>
              <label class="block font-bold mb-2">Nom *</label>
              <input type="text" x-model="profileForm.nom" required class="brutal-input w-full px-4 py-3"
                placeholder="Dupont" />
            </div>
          </div>

          <div class="mb-4">
            <label class="block font-bold mb-2">T√©l√©phone</label>
            <input type="tel" x-model="profileForm.telephone" class="brutal-input w-full px-4 py-3"
              placeholder="06 12 34 56 78" />
          </div>

          <div class="mb-6">
            <label class="block font-bold mb-2">Taille T-shirt *</label>
            <select x-model="profileForm.taille_tshirt" required class="brutal-input w-full px-4 py-3 font-bold">
              <option value="">-- S√©lectionnez --</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
            </select>
          </div>

          <div class="flex flex-col md:flex-row gap-4">
            <button type="submit" :disabled="loading"
              class="brutal-btn bg-brutal-ice w-full py-4 text-xl shadow-brutal">
              <span x-show="!loading">‚úÖ Enregistrer mon profil</span>
              <span x-show="loading">‚è≥ Enregistrement...</span>
            </button>

            <button type="button" x-show="profile" @click="toggleProfile()"
              class="brutal-btn bg-gray-200 text-black w-full md:w-auto py-4 text-xl shadow-brutal-sm">
              Annuler
            </button>
          </div>
        </form>
      </div>

      <!-- Liste des Postes -->
      <div x-show="profile && !showProfileEdit">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <h2 class="text-4xl font-black text-brutal-black">üìã Postes disponibles</h2>

          <!-- Filtres -->
          <div class="flex flex-wrap gap-3">
            <button @click="showMyInscriptions = !showMyInscriptions"
              class="brutal-btn px-4 py-2 text-sm font-bold border-2 border-brutal-black shadow-brutal-sm transition-all active:scale-95 flex items-center gap-2"
              :class="showMyInscriptions ? 'bg-brutal-black text-brutal-white' : 'bg-white text-brutal-black'">
              <span x-text="showMyInscriptions ? '‚úÖ' : '‚¨ú'"></span>
              <span>Mes inscriptions</span>
            </button>
          </div>
        </div>

        <!-- Groupement par p√©riode -->
        <template x-for="group in groupedPostes" :key="group.name">
          <div class="mb-12" x-data="{ open: true }">
            <!-- Period Header with Neo-Brutalist Style -->
            <div @click="open = !open"
              class="brutal-card bg-brutal-black text-brutal-white p-6 mb-6 cursor-pointer hover:bg-gray-900 transition-colors flex justify-between items-center select-none">
              <div>
                <h3 class="text-3xl font-black uppercase tracking-wide" x-text="group.name"></h3>
                <div class="mt-2 flex items-center gap-4">
                  <span class="font-bold text-lg">
                    üìä <span x-text="group.postes.length"></span> poste<span x-show="group.postes.length > 1">s</span>
                  </span>
                  <span class="font-bold text-lg">
                    üë• <span x-text="group.postes.reduce((sum, p) => sum + p.inscrits_actuels, 0)"></span> /
                    <span x-text="group.postes.reduce((sum, p) => sum + p.nb_max, 0)"></span> inscrit<span
                      x-show="group.postes.reduce((sum, p) => sum + p.inscrits_actuels, 0) > 1">s</span>
                  </span>
                </div>
              </div>
              <div class="text-4xl transform transition-transform duration-300" :class="open ? 'rotate-180' : ''">
                ‚ñº
              </div>
            </div>

            <div class="grid gap-6" x-show="open" x-transition>
              <template x-for="poste in group.postes" :key="poste.poste_id">
                <div>
                  <!-- VUE COMPACTE (CONFLIT) -->
                  <template x-if="hasTimeConflict(poste)">
                    <div
                      class="brutal-card bg-gray-200 p-4 opacity-60 flex flex-col md:flex-row md:items-center justify-between gap-4 border-2 border-gray-400 border-dashed">
                      <div class="flex items-center gap-4">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div>
                          <h4 class="font-bold text-lg text-gray-700 line-through decoration-red-500 decoration-2"
                            x-text="poste.titre"></h4>
                          <p class="text-sm font-bold text-gray-500">
                            <span x-text="formatDate(poste.periode_debut)"></span> -
                            <span x-text="formatTime(poste.periode_debut)"></span> √† <span
                              x-text="formatTime(poste.periode_fin)"></span>
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center gap-4">
                        <span class="font-bold text-red-600 text-sm uppercase tracking-wider">Indisponible
                          (Conflit)</span>
                      </div>
                    </div>
                  </template>

                  <!-- VUE NORMALE -->
                  <template x-if="!hasTimeConflict(poste)">
                    <div class="brutal-card p-6"
                      :class="isUserRegistered(poste.poste_id) ? 'bg-green-100' : 'bg-brutal-white'">

                      <!-- Titre, Horaires et R√©f√©rent -->
                      <div class="mb-4 flex flex-col md:flex-row md:items-center md:gap-6">
                        <h4 class="text-2xl font-black" x-text="poste.titre"></h4>
                        <p class="text-lg font-bold text-gray-700">
                          üìÖ <span x-text="formatDate(poste.periode_debut)"></span>
                          -
                          <span x-text="formatTime(poste.periode_debut)"></span>
                          √†
                          <span x-text="formatTime(poste.periode_fin)"></span>
                        </p>

                        <div x-show="poste.referent_nom" class="md:ml-auto">
                          <p class="font-bold">
                            üë§ R√©f√©rent : <span x-text="poste.referent_nom"></span>
                          </p>
                        </div>
                      </div>

                      <!-- Description -->
                      <div x-show="poste.description" class="mb-4 p-4 bg-gray-100 border-3 border-brutal-black">
                        <p class="font-bold" x-text="poste.description"></p>
                      </div>

                      <!-- Barre de progression -->
                      <div class="mb-4">
                        <div class="flex justify-between mb-2">
                          <span class="font-bold">Inscrits</span>
                          <span class="font-black" x-text="poste.inscrits_actuels + ' / ' + poste.nb_max"></span>
                        </div>

                        <div class="progress-bar">
                          <div class="progress-fill" :class="{
                              'bg-green-500': (poste.inscrits_actuels / poste.nb_max) < 0.7,
                              'bg-orange-500': (poste.inscrits_actuels / poste.nb_max) >= 0.7 && (poste.inscrits_actuels / poste.nb_max) < 0.9,
                              'bg-red-500': (poste.inscrits_actuels / poste.nb_max) >= 0.9
                            }" :style="'width: ' + ((poste.inscrits_actuels / poste.nb_max) * 100) + '%'"></div>
                        </div>
                      </div>

                      <!-- Liste des b√©n√©voles inscrits -->
                      <div x-show="poste.liste_benevoles && poste.liste_benevoles.length > 0" class="mb-4">
                        <p class="font-bold mb-2">B√©n√©voles inscrits :</p>
                        <div class="flex flex-wrap gap-2">
                          <template x-for="benevole in poste.liste_benevoles" :key="benevole">
                            <span
                              class="px-3 py-1 bg-brutal-black text-brutal-white font-bold text-sm border-2 border-brutal-black">
                              <span x-text="benevole"></span>
                            </span>
                          </template>
                        </div>
                      </div>

                      <!-- Bouton d'inscription -->
                      <div>
                        <template x-if="isUserRegistered(poste.poste_id)">
                          <button @click="unregister(poste.poste_id)"
                            class="brutal-btn bg-red-500 text-brutal-white px-6 py-3 shadow-brutal-sm w-full md:w-auto">
                            ‚ùå Se d√©sinscrire
                          </button>
                        </template>

                        <template x-if="!isUserRegistered(poste.poste_id)">
                          <div>
                            <!-- NOTE: Le cas hasTimeConflict est g√©r√© par la vue compacte au dessus, mais on garde la logique ici au cas o√π -->
                            <template x-if="!hasTimeConflict(poste) && poste.inscrits_actuels >= poste.nb_max">
                              <button disabled
                                class="brutal-btn bg-gray-300 text-gray-600 px-6 py-3 shadow-brutal-sm cursor-not-allowed w-full md:w-auto">
                                üö´ Complet
                              </button>
                            </template>

                            <template x-if="!hasTimeConflict(poste) && poste.inscrits_actuels < poste.nb_max">
                              <button @click="register(poste.poste_id)"
                                class="brutal-btn bg-brutal-ice px-6 py-3 shadow-brutal w-full md:w-auto hover:bg-brutal-ice/90">
                                ‚úÖ Je m'inscris
                              </button>
                            </template>
                          </div>
                        </template>
                      </div>

                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>

    </section>

  </main>

  <!-- Main Application Logic -->
  <script type="module" src="./src/js/main.js"></script>

</body>

</html>